# name: test/sql/tcc_module_modes.test
# description: mode coverage for tcc_module
# group: [ducktinycc]

require ducktinycc

query TTTT
SELECT ok, mode, code, detail
FROM tcc_module(mode := 'config_set', runtime_path := '/tmp/runtime-a');
----
true	config_set	OK	/tmp/runtime-a

query TTT
SELECT ok, mode, code
FROM tcc_module(mode := 'config_get');
----
true	config_get	OK

query TTT
SELECT ok, mode, code
FROM tcc_module(mode := 'config_reset');
----
true	config_reset	OK

query TTT
SELECT ok, mode, code
FROM tcc_module(mode := 'list');
----
true	list	OK

query TTT
SELECT ok, mode, code
FROM tcc_module(mode := 'register');
----
false	register	E_MISSING_ARGS

query TTT
SELECT ok, mode, code
FROM tcc_module(mode := 'unregister');
----
false	unregister	E_MISSING_ARGS

query TTT
SELECT ok, mode, code
FROM tcc_module(mode := 'call');
----
false	call	E_BAD_MODE

query TTT
SELECT ok, mode, code
FROM tcc_module(mode := 'nonsense');
----
false	nonsense	E_BAD_MODE

query TTT
SELECT ok, mode, code
FROM tcc_module(
  mode := 'register',
  source := 'long long tcc_add1(long long x){ return x + 1; }',
  symbol := 'tcc_add1',
  sql_name := 'tcc_add1',
  return_type := 'i64',
  arg_types := ['i64']
);
----
true	register	OK

query TTT
SELECT ok, mode, code
FROM tcc_module(mode := 'tcc_new_state');
----
true	tcc_new_state	OK

query TTT
SELECT ok, mode, code
FROM tcc_module(
  mode := 'add_source',
  source := 'long long tcc_add2(long long x){ return x + 2; }'
);
----
true	add_source	OK

query TTT
SELECT ok, mode, code
FROM tcc_module(
  mode := 'tinycc_bind',
  symbol := 'tcc_add2',
  sql_name := 'tcc_add2'
);
----
true	tinycc_bind	OK

query TTT
SELECT ok, mode, code
FROM tcc_module(mode := 'tinycc_compile', return_type := 'i64', arg_types := ['i64']);
----
true	tinycc_compile	OK

query TTT
SELECT ok, mode, code
FROM tcc_module(
  mode := 'register',
  source := 'long long tcc_add3(long long a,long long b,long long c){ return a+b+c; }',
  symbol := 'tcc_add3',
  sql_name := 'tcc_add3',
  return_type := 'i64',
  arg_types := ['i64','i64','i64']
);
----
true	register	OK

query TTT
SELECT ok, mode, code
FROM tcc_module(
  mode := 'load',
  sql_name := 'jit_module_add100',
  symbol := 'jit_mod_init',
  source := '
    typedef struct _duckdb_connection *duckdb_connection;
    extern _Bool ducktinycc_register_i64_unary(duckdb_connection con, const char *name, void *fn_ptr);
    long long jit_add100_impl(long long x) { return x + 100; }
    _Bool jit_mod_init(duckdb_connection con) {
      return ducktinycc_register_i64_unary(con, "jit_add100", (void *)jit_add100_impl);
    }
  '
);
----
true	load	OK

query I
SELECT jit_add100(7);
----
107

query TTT
SELECT ok, mode, code
FROM tcc_module(
  mode := 'unregister',
  sql_name := 'jit_module_add100'
);
----
false	unregister	E_UNSAFE_UNLOAD

query TTT
SELECT ok, mode, code
FROM tcc_module(
  mode := 'register',
  source := 'long long tcc_badret(long long x){ return x; }',
  symbol := 'tcc_badret',
  sql_name := 'tcc_badret',
  return_type := 'f64',
  arg_types := ['i64']
);
----
false	register	E_COMPILE_FAILED

query TTT
SELECT ok, mode, code
FROM tcc_module(
  mode := 'register',
  source := 'long long tcc_toomany(long long a0,long long a1,long long a2,long long a3,long long a4,long long a5,long long a6,long long a7,long long a8,long long a9,long long a10){ return a0+a10; }',
  symbol := 'tcc_toomany',
  sql_name := 'tcc_toomany',
  return_type := 'i64',
  arg_types := ['i64','i64','i64','i64','i64','i64','i64','i64','i64','i64','i64']
);
----
false	register	E_COMPILE_FAILED
