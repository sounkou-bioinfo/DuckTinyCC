# name: test/sql/tcc_module_modes.test
# description: clean codegen API coverage for tcc_module
# group: [ducktinycc]

require ducktinycc

query TTTT
SELECT ok, mode, code, detail
FROM tcc_module(mode := 'config_set', runtime_path := '/tmp/runtime-a');
----
true	config_set	OK	/tmp/runtime-a

query TTT
SELECT ok, mode, code
FROM tcc_module(mode := 'config_get');
----
true	config_get	OK

query TTT
SELECT ok, mode, code
FROM tcc_module(mode := 'config_reset');
----
true	config_reset	OK

query TTT
SELECT ok, mode, code
FROM tcc_module(mode := 'list');
----
true	list	OK

query I
SELECT CASE WHEN COUNT(*) > 0 THEN 1 ELSE 0 END
FROM tcc_system_paths();
----
1

query I
SELECT CASE WHEN SUM(CASE WHEN kind = 'runtime' THEN 1 ELSE 0 END) >= 1 THEN 1 ELSE 0 END
FROM tcc_system_paths();
----
1

query I
SELECT CASE WHEN SUM(CASE WHEN kind = 'resolved' AND exists THEN 1 ELSE 0 END) >= 1 THEN 1 ELSE 0 END
FROM tcc_library_probe(library := 'libtcc1.a');
----
1

query I
SELECT CASE WHEN SUM(CASE WHEN kind = 'resolved' AND exists THEN 1 ELSE 0 END) = 0 THEN 1 ELSE 0 END
FROM tcc_library_probe(library := '__ducktinycc_missing_lib__');
----
1

query TTT
SELECT ok, mode, code
FROM tcc_module(mode := 'register');
----
false	register	E_BAD_MODE

query TTT
SELECT ok, mode, code
FROM tcc_module(mode := 'ffi_load');
----
false	ffi_load	E_BAD_MODE

query TTT
SELECT ok, mode, code
FROM tcc_module(mode := 'load');
----
false	load	E_BAD_MODE

query TTT
SELECT ok, mode, code
FROM tcc_module(mode := 'unregister');
----
false	unregister	E_BAD_MODE

query TTT
SELECT ok, mode, code
FROM tcc_module(mode := 'nonsense');
----
false	nonsense	E_BAD_MODE

query TTT
SELECT ok, mode, code
FROM tcc_module(mode := 'new_state');
----
false	new_state	E_BAD_MODE

query TTT
SELECT ok, mode, code
FROM tcc_module(mode := 'bind');
----
false	bind	E_BAD_MODE

query TTT
SELECT ok, mode, code
FROM tcc_module(mode := 'tinycc_compile');
----
false	tinycc_compile	E_BAD_MODE

query TTT
SELECT ok, mode, code
FROM tcc_module(mode := 'tcc_new_state');
----
true	tcc_new_state	OK

query TTT
SELECT ok, mode, code
FROM tcc_module(
  mode := 'add_source',
  source := 'long long add2(long long x){ return x + 2; }'
);
----
true	add_source	OK

query TTT
SELECT ok, mode, code
FROM tcc_module(
  mode := 'tinycc_bind',
  symbol := 'add2',
  sql_name := 'add2'
);
----
true	tinycc_bind	OK

query TTT
SELECT ok, mode, code
FROM tcc_module(mode := 'compile', return_type := 'i64', arg_types := ['i64']);
----
true	compile	OK

query I
SELECT add2(40);
----
42

query I
SELECT CASE WHEN detail LIKE '%ducktinycc_register_signature%' THEN 1 ELSE 0 END
FROM tcc_module(
  mode := 'codegen_preview',
  symbol := 'add2',
  sql_name := 'add2_preview',
  return_type := 'i64',
  arg_types := ['i64']
);
----
1

query TTT
SELECT ok, mode, code
FROM tcc_module(
  mode := 'codegen_preview',
  symbol := 'add2',
  sql_name := 'add2_preview_bad',
  return_type := 'blob',
  arg_types := ['i64']
);
----
false	codegen_preview	E_BAD_SIGNATURE

query TTT
SELECT ok, mode, code
FROM tcc_module(
  mode := 'quick_compile',
  source := 'int add_i32(int a, int b){ return a + b; }',
  symbol := 'add_i32',
  sql_name := 'add_i32',
  return_type := 'i32',
  arg_types := ['i32', 'i32']
);
----
true	quick_compile	OK

query I
SELECT add_i32(20, 22);
----
42

query TTT
SELECT ok, mode, code
FROM tcc_module(
  mode := 'quick_compile',
  source := 'int add_i32(int a, int b){ return a + b + 1; }',
  symbol := 'add_i32',
  sql_name := 'add_i32',
  return_type := 'i32',
  arg_types := ['i32', 'i32']
);
----
false	quick_compile	E_INIT_FAILED

query I
SELECT add_i32(20, 22);
----
42

query TTT
SELECT ok, mode, code
FROM tcc_module(
  mode := 'quick_compile',
  source := '#include <math.h>
double qpow(double x, double y){ return pow(x, y); }',
  symbol := 'qpow',
  sql_name := 'qpow',
  return_type := 'f64',
  arg_types := ['f64', 'f64'],
  include_path := 'third_party/tinycc/include',
  library_path := 'third_party/tinycc',
  library := 'm'
);
----
true	quick_compile	OK

query I
SELECT CAST(qpow(2.0, 5.0) AS BIGINT);
----
32

query TTT
SELECT ok, mode, code
FROM tcc_module(
  mode := 'quick_compile',
  source := '_Bool gt0(long long x){ return x > 0; }',
  symbol := 'gt0',
  sql_name := 'gt0',
  return_type := 'bool',
  arg_types := ['i64']
);
----
true	quick_compile	OK

query TT
SELECT gt0(3), gt0(-1);
----
true	false

query TTT
SELECT ok, mode, code
FROM tcc_module(
  mode := 'quick_compile',
  source := 'double half(double x){ return x / 2.0; }',
  symbol := 'half',
  sql_name := 'half',
  return_type := 'f64',
  arg_types := ['f64']
);
----
true	quick_compile	OK

query I
SELECT CAST(half(8.0) AS BIGINT);
----
4

query TTT
SELECT ok, mode, code
FROM tcc_module(
  mode := 'quick_compile',
  source := 'void touch(int x){ (void)x; }',
  symbol := 'touch',
  sql_name := 'touch',
  return_type := 'void',
  arg_types := ['i32']
);
----
true	quick_compile	OK

query T
SELECT touch(5);
----
NULL

query TTT
SELECT ok, mode, code
FROM tcc_module(mode := 'tcc_new_state');
----
true	tcc_new_state	OK

query TTT
SELECT ok, mode, code
FROM tcc_module(mode := 'add_library', library := 'm');
----
true	add_library	OK

query TTT
SELECT ok, mode, code
FROM tcc_module(
  mode := 'add_source',
  source := '#include <math.h>
double pwr(double x, double y){ return pow(x, y); }'
);
----
true	add_source	OK

query TTT
SELECT ok, mode, code
FROM tcc_module(
  mode := 'tinycc_bind',
  symbol := 'pwr',
  sql_name := 'pwr'
);
----
true	tinycc_bind	OK

query TTT
SELECT ok, mode, code
FROM tcc_module(mode := 'compile', return_type := 'f64', arg_types := ['f64', 'f64']);
----
true	compile	OK

query I
SELECT CAST(pwr(2.0, 5.0) AS BIGINT);
----
32

query TTT
SELECT ok, mode, code
FROM tcc_module(
  mode := 'quick_compile',
  source := 'long long bad(long long x){ return x; }',
  symbol := 'bad',
  sql_name := 'bad',
  return_type := 'blob',
  arg_types := ['i64']
);
----
false	quick_compile	E_BAD_SIGNATURE

query TTT
SELECT ok, mode, code
FROM tcc_module(
  mode := 'quick_compile',
  source := 'long long too_many(long long a0,long long a1,long long a2,long long a3,long long a4,long long a5,long long a6,long long a7,long long a8,long long a9,long long a10){ return a0 + a10; }',
  symbol := 'too_many',
  sql_name := 'too_many',
  return_type := 'i64',
  arg_types := ['i64','i64','i64','i64','i64','i64','i64','i64','i64','i64','i64']
);
----
true	quick_compile	OK

query I
SELECT too_many(1,2,3,4,5,6,7,8,9,10,11);
----
12

query TTT
SELECT ok, mode, code
FROM tcc_module(
  mode := 'quick_compile',
  source := 'long long batch_add(long long a, long long b){ return a + b; }',
  symbol := 'batch_add',
  sql_name := 'batch_add',
  return_type := 'i64',
  arg_types := ['i64','i64'],
  wrapper_mode := 'batch'
);
----
true	quick_compile	OK

query I
SELECT CAST(SUM(batch_add(i, 2)) AS BIGINT)
FROM range(1000) AS t(i);
----
501500

query TTT
SELECT ok, mode, code
FROM tcc_module(
  mode := 'quick_compile',
  source := 'long long batch_double(long long x){ return x * 2; }',
  symbol := 'batch_double',
  sql_name := 'batch_double',
  return_type := 'i64',
  arg_types := ['i64'],
  wrapper_mode := 'batch'
);
----
true	quick_compile	OK

query TT
SELECT batch_double(NULL), batch_double(21);
----
NULL	42

query TTT
SELECT ok, mode, code
FROM tcc_module(
  mode := 'quick_compile',
  source := 'void batch_touch(long long x){ (void)x; }',
  symbol := 'batch_touch',
  sql_name := 'batch_touch',
  return_type := 'void',
  arg_types := ['i64'],
  wrapper_mode := 'batch'
);
----
true	quick_compile	OK

query I
SELECT COUNT(*)::BIGINT
FROM range(128) AS t(i)
WHERE batch_touch(i) IS NULL;
----
128

query TTT
SELECT ok, mode, code
FROM tcc_module(
  mode := 'quick_compile',
  source := 'long long bad_wrapper(long long x){ return x; }',
  symbol := 'bad_wrapper',
  sql_name := 'bad_wrapper',
  return_type := 'i64',
  arg_types := ['i64'],
  wrapper_mode := 'arrow'
);
----
false	quick_compile	E_BAD_WRAPPER_MODE
